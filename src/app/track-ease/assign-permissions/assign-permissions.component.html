<div class="">
    @if (permissions$ | async; as permissions) {
    @if (permissions.length) {
    <table mat-table [dataSource]="permissions" class="mat-elevation-z1">
        <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef>Permission</th>
            <td mat-cell *matCellDef="let permission">
                <div class="permission-code">{{ permission.code }}</div>
                @if (permission.description) {
                <div class="permission-description">
                    {{ permission.description }}
                </div>
                }
            </td>
        </ng-container>
        @for (column of roleColumns; track column) {
        <ng-container [matColumnDef]="column.columnKey">
            <th mat-header-cell *matHeaderCellDef>
                {{ column.label }}
            </th>
            <td mat-cell *matCellDef="let permission">
                <mat-checkbox color="primary" [checked]="
                                            isPermissionAssigned(
                                                column.columnKey,
                                                permission.code
                                            )
                                        " [disabled]="
                                            !hasRole(column.columnKey) ||
                                            isSaving ||
                                            isRoleAssignmentsLoading
                                        " (change)="
                                            onPermissionToggle(
                                                column.columnKey,
                                                permission.code,
                                                $event.checked
                                            )
                                        "></mat-checkbox>
            </td>
        </ng-container>
        }
        <tr mat-header-row *matHeaderRowDef="assignmentColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: assignmentColumns"></tr>
    </table>
    }
    }
</div>

@if (hasPendingChanges) {
<mat-toolbar class="action-bar">
    <div class="action-bar-content">
        <span class="action-bar-message">Save changes</span>
        <div class="action-bar-buttons">
            <button mat-stroked-button (click)="onCancelChanges()" [disabled]="isSaving">
                Cancel
            </button>
            <button mat-raised-button color="primary" (click)="onSaveChanges()" [disabled]="isSaving">
                @if (isSaving) {
                <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
                Saving...
                } @else {
                Save
                }
            </button>
        </div>
    </div>
</mat-toolbar>
}